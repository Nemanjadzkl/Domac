<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stara Koliba - Intro</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- GSAP + ScrollTrigger -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

  <!-- PhotoSphereViewer -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photo-sphere-viewer@4/dist/photo-sphere-viewer.css"/>
  <script src="https://cdn.jsdelivr.net/npm/uevent@2/browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/photo-sphere-viewer@4/dist/photo-sphere-viewer.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/photo-sphere-viewer@4/dist/plugins/markers.min.js"></script>

  <style>
    body, html {
      margin: 0; padding: 0;
      overflow-x: hidden;
      background: black;
    }
    #intro video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      will-change: clip-path;
      display: block;
    }
    #intro {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100vh;
      overflow: hidden;
      z-index: 2;
    }
    #panorama {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100vh;
      z-index: 1;
    }
    #loadingScreen {
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:black;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      z-index:9999;
    }
  </style>
</head>
<body class="bg-black">

  <!-- Loading -->
  <div id="loadingScreen">
    <div class="text-white mb-4">Učitavanje...</div>
    <div class="w-64 bg-gray-700 rounded-full h-2.5">
      <div id="loadingBar" class="bg-green-500 h-2.5 rounded-full w-0"></div>
    </div>
  </div>

  <!-- Intro video -->
  <section id="intro">
    <video id="introVideo" src="Timeline 1.mp4" preload="auto" playsinline muted></video>
  </section>

  <!-- Panorama -->
  <section id="panorama"></section>

  <!-- Brand Shelf Modal -->
  <div id="shelfModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg max-w-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Polica sa Brendom</h2>
        <button onclick="closeShelfModal()" class="text-3xl font-light">&times;</button>
      </div>
      <p class="text-gray-700">Ovde će biti detaljan prikaz naših proizvoda sa police. Svaka flaša će imati svoju priču, od procesa proizvodnje do degustacionih nota. Uskoro više informacija!</p>
      <button onclick="closeShelfModal()" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-lg">Zatvori</button>
    </div>
  </div>

  <!-- History Modal -->
  <div id="albumModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg max-w-2xl p-6 w-full">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Naša Priča</h2>
        <button onclick="closeAlbumModal()" class="text-3xl font-light">&times;</button>
      </div>
      <!-- Slider -->
      <div class="relative">
        <img id="albumImage" src="https://placehold.co/800x600/1a1a1a/ffffff?text=Slika+1" alt="Album slika" class="w-full h-96 object-cover rounded-lg">
        <button onclick="prevImage()" class="absolute left-0 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full ml-2">‹</button>
        <button onclick="nextImage()" class="absolute right-0 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full mr-2">›</button>
      </div>
      <p id="albumCaption" class="text-gray-700 mt-4">Ovo je opis za prvu sliku u albumu.</p>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg max-w-lg p-6">
      <h2 class="text-xl font-bold mb-4">Kazani za rakiju</h2>
      <p class="text-gray-700">Ovo je demo opis procesa pečenja rakije. Kasnije ovde možemo dodati galeriju i detalje.</p>
      <button onclick="closeModal()" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-lg">Zatvori</button>
    </div>
  </div>

  <script>
    const video = document.getElementById("introVideo");
    const loadingScreen = document.getElementById("loadingScreen");
    const loadingBar = document.getElementById("loadingBar");
    const panoramaSection = document.getElementById("panorama");

    // ✦ Držimo video pauziran – mi ga kontrolisemo
    video.pause();

    video.addEventListener("loadedmetadata", () => {
      let duration = video.duration;
      let targetTime = 0;
      let currentTime = 0;
      let animationCompleted = false; // Flag to prevent re-animation

      // Inicijalizujemo panoramu odmah, i ucitavamo Markers plugin
      const viewer = new PhotoSphereViewer.Viewer({
        container: panoramaSection,
        panorama: "https://raw.githubusercontent.com/Nemanjadzkl/Domac/main/panorama_360.png",
        defaultLong: 0,
        touchmoveTwoFingers: true,
        navbar: [ 'zoom', 'fullscreen' ],
        plugins: [
          // Ukljucujemo Markers plugin
          [PhotoSphereViewer.MarkersPlugin, {}]
        ]
      });

      // Dobijamo instancu plugina da bismo dodavali markere
      const markersPlugin = viewer.getPlugin(PhotoSphereViewer.MarkersPlugin);

      // Hotspotovi
      const modal = document.getElementById("modal");
      markersPlugin.addMarker({
        id: "kazani",
        longitude: -0.2, latitude: 0,
        image: "https://cdn-icons-png.flaticon.com/512/2913/2913986.png", // Press icon
        width: 40, height: 40, tooltip: "Kazani za rakiju",
      });
      markersPlugin.addMarker({
        id: "history",
        longitude: 1.0, latitude: -0.4,
        image: "https://cdn-icons-png.flaticon.com/512/32/32223.png", // History/scroll icon
        width: 32, height: 32, tooltip: "Naša Priča",
      });
      markersPlugin.addMarker({
        id: "shelf",
        longitude: -1.5, latitude: 0.3,
        image: "https://cdn-icons-png.flaticon.com/512/30/30449.png", // Bottle icon
        width: 32, height: 32, tooltip: "Polica sa brendom",
      });

      // Event listener sada ide na plugin
      markersPlugin.on("select-marker", (e, marker) => {
        if (marker.id === "kazani") {
          modal.style.display="flex";
        } else if (marker.id === "history") {
          document.getElementById("albumModal").style.display = "flex";
        } else if (marker.id === "shelf") {
          document.getElementById("shelfModal").style.display = "flex";
        }
      });

      // Loading bar animacija
      gsap.to(loadingBar, {
        width: "100%",
        duration: 1,
        onComplete: () => {
          gsap.to(loadingScreen, {opacity:0, duration:0.5, onComplete:()=> loadingScreen.style.display="none"});
        }
      });

      // Frame loop za glatko kretanje videa
      function updateFrame() {
        currentTime += (targetTime - currentTime) * 0.1;
        if (Math.abs(targetTime - currentTime) > 0.001) {
          video.currentTime = Math.min(duration, Math.max(0, currentTime));
        }
        requestAnimationFrame(updateFrame);
      }
      requestAnimationFrame(updateFrame);

      gsap.registerPlugin(ScrollTrigger);

      // Jedan ScrollTrigger koji kontroliše celu animaciju u dve faze
      gsap.to({}, { // Prazan objekat, koristimo samo onUpdate
        scrollTrigger: {
          id: "main-trigger",
          trigger: '#intro',
          pin: true,
          scrub: 1,
          end: () => "+=" + (window.innerHeight * 5), // 5x visina ekrana za ceo proces
          onUpdate: (self) => {
            if (animationCompleted) return;

            const videoPhaseEnd = 0.8; // 80% skrola je za video

            if (self.progress < videoPhaseEnd) {
              // FAZA 1: Puštanje videa
              targetTime = (self.progress / videoPhaseEnd) * duration;
              gsap.set(video, { clearProps: 'clipPath' }); // Resetujemo clip-path
            } else {
              // FAZA 2: Otkrivanje panorame kroz "vrata"
              targetTime = duration; // Držimo video na kraju

              const revealProgress = (self.progress - videoPhaseEnd) / (1 - videoPhaseEnd);

              // Animiramo clip-path od centra ka ivicama vrata (približne vrednosti)
              const startX = 50 - (revealProgress * 15); // 50% -> 35%
              const endX   = 50 + (revealProgress * 15); // 50% -> 65%
              const startY = 50 - (revealProgress * 40); // 50% -> 10%
              const endY   = 50 + (revealProgress * 40); // 50% -> 90%

              video.style.clipPath = `polygon(${startX}% ${startY}%, ${endX}% ${startY}%, ${endX}% ${endY}%, ${startX}% ${endY}%)`;
            }
          },
          onLeave: (self) => {
            if (animationCompleted) return;
            animationCompleted = true;

            // Kraj animacije: Sakrij intro i prepusti kontrolu panorami
            gsap.to("#intro", {
                opacity: 0,
                duration: 0.5,
                onComplete: () => {
                    self.kill();
                    document.getElementById("intro").style.display = "none";
                }
            });
          }
        }
      });
    });

    // Modal close
    function closeModal() {
      document.getElementById("modal").style.display="none";
    }

    // --- Album Slider Logic ---
    const albumModal = document.getElementById("albumModal");
    const albumImage = document.getElementById("albumImage");
    const albumCaption = document.getElementById("albumCaption");

    const albumData = [
        { src: "https://placehold.co/800x600/1a1a1a/ffffff?text=Slika+1", caption: "Ovo je placeholder opis za prvu sliku." },
        { src: "https://placehold.co/800x600/3a3a3a/ffffff?text=Slika+2", caption: "Opis za drugu sliku, prikazuje proces proizvodnje." },
        { src: "https://placehold.co/800x600/5a5a5a/ffffff?text=Slika+3", caption: "Treća slika, naša stara koliba spolja." }
    ];
    let currentImageIndex = 0;

    function updateAlbum() {
        albumImage.src = albumData[currentImageIndex].src;
        albumCaption.textContent = albumData[currentImageIndex].caption;
    }

    function nextImage() {
        currentImageIndex = (currentImageIndex + 1) % albumData.length;
        updateAlbum();
    }

    function prevImage() {
        currentImageIndex = (currentImageIndex - 1 + albumData.length) % albumData.length;
        updateAlbum();
    }

    function closeAlbumModal() {
        albumModal.style.display = "none";
        // Reset to first image when closing
        currentImageIndex = 0;
        updateAlbum();
    }

    function closeShelfModal() {
      document.getElementById("shelfModal").style.display = "none";
    }
  </script>
</body>
</html>
