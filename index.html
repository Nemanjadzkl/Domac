<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stara Koliba - Intro</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- GSAP + ScrollTrigger -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

  <!-- PhotoSphereViewer -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photo-sphere-viewer@4/dist/photo-sphere-viewer.css"/>
  <script src="https://cdn.jsdelivr.net/npm/uevent@2/browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/photo-sphere-viewer@4/dist/photo-sphere-viewer.js"></script>

  <style>
    body, html {
      margin: 0; padding: 0;
      overflow-x: hidden;
      background: black;
    }
    #intro video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      will-change: clip-path;
      display: block;
    }
    #intro {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100vh;
      overflow: hidden;
      z-index: 2;
    }
    #panorama {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100vh;
      z-index: 1;
    }
    #loadingScreen {
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:black;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      z-index:9999;
    }
  </style>
</head>
<body class="bg-black">

  <!-- Loading -->
  <div id="loadingScreen">
    <div class="text-white mb-4">Učitavanje...</div>
    <div class="w-64 bg-gray-700 rounded-full h-2.5">
      <div id="loadingBar" class="bg-green-500 h-2.5 rounded-full w-0"></div>
    </div>
  </div>

  <!-- Intro video -->
  <section id="intro">
    <video id="introVideo" src="Timeline 1.mp4" preload="auto" playsinline muted></video>
  </section>

  <!-- Panorama -->
  <section id="panorama"></section>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg max-w-lg p-6">
      <h2 class="text-xl font-bold mb-4">Kazani za rakiju</h2>
      <p class="text-gray-700">Ovo je demo opis procesa pečenja rakije. Kasnije ovde možemo dodati galeriju i detalje.</p>
      <button onclick="closeModal()" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-lg">Zatvori</button>
    </div>
  </div>

  <script>
    const video = document.getElementById("introVideo");
    const loadingScreen = document.getElementById("loadingScreen");
    const loadingBar = document.getElementById("loadingBar");
    const panoramaSection = document.getElementById("panorama");

    // ✦ Držimo video pauziran – mi ga kontrolisemo
    video.pause();

    video.addEventListener("loadedmetadata", () => {
      let duration = video.duration;
      let targetTime = 0;
      let currentTime = 0;

      // Inicijalizujemo panoramu odmah, biće sakrivena iza videa
      const viewer = new PhotoSphereViewer.Viewer({
        container: panoramaSection,
        panorama: "unutrasnjost.jpg",
        defaultYaw: 0,
        touchmoveTwoFingers: true,
        navbar: [ 'zoom', 'fullscreen' ]
      });

      // Hotspot
      const modal = document.getElementById("modal");
      viewer.addMarker({
        id: "kazani",
        longitude: 0.5, latitude: 0.1,
        image: "https://cdn-icons-png.flaticon.com/512/69/69957.png",
        width: 32, height: 32, tooltip: "Kazani za rakiju",
      });
      viewer.on("select-marker", (e, marker) => {
        if(marker.id === "kazani") modal.style.display="flex";
      });

      // Loading bar animacija
      gsap.to(loadingBar, {
        width: "100%",
        duration: 1,
        onComplete: () => {
          gsap.to(loadingScreen, {opacity:0, duration:0.5, onComplete:()=> loadingScreen.style.display="none"});
        }
      });

      // Frame loop za glatko kretanje videa
      function updateFrame() {
        currentTime += (targetTime - currentTime) * 0.1;
        if (Math.abs(targetTime - currentTime) > 0.001) {
          video.currentTime = Math.min(duration, Math.max(0, currentTime));
        }
        requestAnimationFrame(updateFrame);
      }
      requestAnimationFrame(updateFrame);

      gsap.registerPlugin(ScrollTrigger);

      // Jedan ScrollTrigger koji kontroliše celu animaciju u dve faze
      gsap.to({}, { // Prazan objekat, koristimo samo onUpdate
        scrollTrigger: {
          id: "main-trigger",
          trigger: '#intro',
          pin: true,
          scrub: 1,
          end: () => "+=" + (window.innerHeight * 5), // 5x visina ekrana za ceo proces
          onUpdate: (self) => {
            const videoPhaseEnd = 0.8; // 80% skrola je za video

            if (self.progress < videoPhaseEnd) {
              // FAZA 1: Puštanje videa
              targetTime = (self.progress / videoPhaseEnd) * duration;
              gsap.set(video, { clearProps: 'clipPath' }); // Resetujemo clip-path
            } else {
              // FAZA 2: Otkrivanje panorame kroz "vrata"
              targetTime = duration; // Držimo video na kraju

              const revealProgress = (self.progress - videoPhaseEnd) / (1 - videoPhaseEnd);

              // Animiramo clip-path od centra ka ivicama vrata (približne vrednosti)
              const startX = 50 - (revealProgress * 15); // 50% -> 35%
              const endX   = 50 + (revealProgress * 15); // 50% -> 65%
              const startY = 50 - (revealProgress * 40); // 50% -> 10%
              const endY   = 50 + (revealProgress * 40); // 50% -> 90%

              video.style.clipPath = `polygon(${startX}% ${startY}%, ${endX}% ${startY}%, ${endX}% ${endY}%, ${startX}% ${endY}%)`;
            }
          },
          onLeave: (self) => {
            // Kraj animacije: Sakrij intro i prepusti kontrolu panorami
            gsap.to("#intro", {
                opacity: 0,
                duration: 0.5,
                onComplete: () => {
                    self.kill();
                    document.getElementById("intro").style.display = "none";
                }
            });
          }
        }
      });
    });

    // Modal close
    function closeModal() {
      document.getElementById("modal").style.display="none";
    }
  </script>
</body>
</html>
